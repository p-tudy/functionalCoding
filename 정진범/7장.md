# 신뢰할 수 없는 코드를 쓰면서 불변성 지키기

## 레거시 코드와 불변성 
기존의 코드에 함수가 추가하고 호출하면 카피-온-라이트 원칙을 지킬 수 없게 된다. 하지만 카피-온-라이트 원칙을 지키면서 안전하게 함수를 사용할 수 있는 원칙을 방어적 복사라고 한다.

### 방어적 복사는 원본이 바뀌는 것을 막아 줍니다.
신뢰할 수 없는 코드와 데이터를 주고받는 문제를 푸는 방법은 복사본을 만드는 것입니다.
바뀔 수도 있는 데이터가 신뢰할 수 없는 코드에서 안전지대로 들어옵니다. 들어온 데이터로 깊은 복사본을 만들고 변경 가능한 원본을 버립니다.
신뢰 할 수 잇는 코드만 복사본을 쓰기 때문에 데이터는 변경되지 않습니다
위와 같은 방법으로 들어오는 데이터를 보호 할 수 있습니다.

### 방어적 복사 규칙 
규칙1: 데이터가 안전한 코드에서 나갈 때 복사하기 
 - 불변성 데이터를 위한 깊은 복사본을 만든다.
 - 신뢰할 수 없는 코드로 복사본을 전달한다.
   
규칙2: 안전한 코드로 데이터가 들어올때 복사하기
 - 변경될 수도 있는 데이터가 들어오면 바로 깊은 복사본을 만들어 안전한 코드로 전달한다
 - 복사본을 안전한 코드에서 사용합니다


### 카피-온-라이트와 방어적 복사를 비교해보자 
||카피-온-라이트|방어적 복사|
|------|---|---|
|언제 쓰나요?|통제할 수 있는 데이터를 바꿀때|신뢰할 수 없는 코드와 데이터를 주고받을때|
|어디서 쓰나요?|안전지대 어디서나 쓸 수 있다.|안전지대의 경계에서 데이터가 오고 갈 때|
|복사 방식|얕은 복사(상대적으로 비용이 적다)|깊은 복사(상대적으로 비용이 많다)|
|규칙| 바꿀 데이터의 얕은 복사 -> 복사본을 변경합니다. -> 복사본을 리턴합니다.| 안전지대로 들어노는 데이터에 깊은 복사 -> 안전지대에서 나가는 데이터에 깊은 복사|
